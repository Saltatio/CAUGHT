<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Caught! - Magnetic Gold Edition</title>
    <style>
        body { margin: 0; background: #222; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #game-container { position: relative; width: 600px; height: 600px; border: 5px solid #fff; border-radius: 20px; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.9); background: #1a1a1a; }
        canvas { position: absolute; top: 0; left: 0; cursor: pointer; z-index: 1; }
        #seasonal-gif { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: cover; opacity: 0.5; z-index: 5; pointer-events: none; 
            mix-blend-mode: screen; display: none; 
        }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas" width="600" height="600"></canvas>
        <img id="seasonal-gif" src="" alt="seasonal-effect">
    </div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const gifElement = document.getElementById('seasonal-gif');

// --- ASSETS ---
const assets = {
    day: new Image(), afternoon: new Image(), evening: new Image(), 
    paw: new Image(), fish: new Image(),
    cat_default: new Image(), cat_black: new Image(), cat_tabby: new Image()
};
assets.day.src = 'day.png'; assets.afternoon.src = 'afternoon.png'; assets.evening.src = 'evening.png'; 
assets.paw.src = 'paw.png'; assets.fish.src = 'fish.png';
assets.cat_default.src = 'cat.png'; assets.cat_black.src = 'cat_black.png'; assets.cat_tabby.src = 'cat_tabby.png';

const musicTracks = [new Audio('spring.mp3'), new Audio('summer.mp3'), new Audio('autumn.mp3')];
musicTracks.forEach(t => { t.loop = true; t.volume = 0; });
const timeGifs = ['spring.gif', 'summer.gif', 'autumn.gif'];

// --- GAME STATE ---
let gameState = 'MAIN_MENU', score = 0, starsCount = 0, frames = 0, lastCycleIdx = -1;
let highScore = localStorage.getItem('caughtHighScore') || 0;
let catY = 300, catV = 0, catPaws = [], stars = [], powerUps = [], particles = [], rollAngle = 0;
let selectedCatImg = assets.cat_default, mouseX = 0, mouseY = 0;
let activePower = null, powerTimer = 0, splashText = "", splashTimer = 0;
let selectedBG = 'day', lastPowerType = null; 

const charCards = [
    { x: 180, y: 180, img: assets.cat_default, hoverAngle: 0 },
    { x: 300, y: 180, img: assets.cat_black, hoverAngle: 0 },
    { x: 420, y: 180, img: assets.cat_tabby, hoverAngle: 0 }
];

const bgOptions = [
    { x: 180, y: 350, id: 'day', label: 'MORNING' },
    { x: 300, y: 350, id: 'afternoon', label: 'NOON' },
    { x: 420, y: 350, id: 'evening', label: 'NIGHT' }
];

// --- DRAWING HELPERS ---
function drawStar(x, y, points, outer, inner) {
    ctx.beginPath();
    for (let i = 0; i < points * 2; i++) {
        let r = i % 2 === 0 ? outer : inner;
        let a = (Math.PI * i) / points;
        ctx.lineTo(x + r * Math.sin(a), y - r * Math.cos(a));
    }
    ctx.closePath();
    ctx.fill();
}

function createGoldenBurst(x, y) {
    for(let i=0; i<15; i++) {
        particles.push({
            x: x, y: y,
            vx: (Math.random() - 0.5) * 14,
            vy: (Math.random() - 0.5) * 14,
            life: 1.0,
            size: Math.random() * 4 + 2,
            color: Math.random() > 0.5 ? '#FFD700' : '#FFFACD'
        });
    }
}

function updateMasterSync() {
    let cycleIdx = Math.floor(starsCount / 20) % 3;
    if (cycleIdx !== lastCycleIdx && gameState === 'PLAY') {
        gifElement.src = timeGifs[cycleIdx];
        gifElement.style.display = 'block';
        lastCycleIdx = cycleIdx;
    }
    musicTracks.forEach((track, i) => {
        if (gameState === 'PLAY' && i === cycleIdx) {
            if (track.paused) track.play().catch(()=>{});
            track.volume = Math.min(track.volume + 0.01, 0.4);
        } else {
            track.volume = Math.max(track.volume - 0.02, 0);
            if (track.volume === 0) track.pause();
        }
    });
}

function spawnPowerUp() {
    const types = ['SHIELD', 'MAGNET', 'SLOW'];
    let newType = types[Math.floor(Math.random() * types.length)];
    if (newType === lastPowerType) newType = types[Math.floor(Math.random() * types.length)];
    lastPowerType = newType;
    powerUps.push({ x: 850, baseY: Math.random() * 300 + 150, y: 300, type: newType, floatOffset: Math.random() * Math.PI * 2 });
}

// --- CORE ENGINE ---
function update() {
    if (gameState === 'MAIN_MENU') {
        frames++;
        charCards.forEach(c => {
            let h = (mouseX > c.x-40 && mouseX < c.x+40 && mouseY > c.y-40 && mouseY < c.y+40);
            if (h) c.hoverAngle += 0.06; else c.hoverAngle *= 0.9;
        });
        return;
    }
    if (gameState !== 'PLAY') return;

    frames++;
    updateMasterSync();
    
    let baseSpeed = 4.2 + (score * 0.08);
    let speed = activePower === 'SLOW' ? baseSpeed * 0.5 : baseSpeed;
    
    rollAngle += 0.04;
    if (powerTimer > 0) powerTimer--; else activePower = null;
    if (splashTimer > 0) splashTimer--;

    if (frames % 100 === 0) {
        let gapSize = Math.random() * 70 + 130;
        let h = Math.random() * (500 - gapSize) + 50;
        catPaws.push({ x: 650, yT: h, yB: h + gapSize, passed: false });
        stars.push({ x: 800, y: h + (gapSize/2), collected: false });
    }

    catPaws.forEach(p => {
        p.x -= speed;
        if (120 + 20 > p.x + 115 && 120 - 20 < p.x + 185) {
            if ((catY - 20 < p.yT || catY + 20 > p.yB) && activePower !== 'SHIELD') triggerGameOver();
        }
        if (!p.passed && p.x + 150 < 120) { score++; p.passed = true; }
    });

    stars.forEach(s => {
        s.x -= speed;
        let d = Math.sqrt((120-s.x)**2 + (catY-s.y)**2);
        if (activePower === 'MAGNET' && d < 220) { 
            s.x += (120-s.x)*0.12; s.y += (catY-s.y)*0.12; 
        }
        if (!s.collected && d < 40) { 
            s.collected = true; starsCount++; 
            createGoldenBurst(s.x, s.y);
            if (starsCount > 0 && starsCount % 10 === 0) spawnPowerUp();
        }
    });

    powerUps.forEach(pu => {
        pu.x -= speed; pu.y = pu.baseY + Math.sin(frames * 0.05 + pu.floatOffset) * 20; 
        if (Math.sqrt((120-pu.x)**2 + (catY-pu.y)**2) < 55) { 
            activePower = pu.type; powerTimer = 480; splashText = pu.type; splashTimer = 90; pu.x = -1000; 
        }
    });

    particles.forEach(p => { p.x += p.vx; p.y += p.vy; p.life -= 0.025; });
    particles = particles.filter(p => p.life > 0);
    catPaws = catPaws.filter(p => p.x > -400);
    stars = stars.filter(s => s.x > -50 && !s.collected);
    
    catV += 0.4; catY += catV;
    if (catY > 600 || catY < 0) triggerGameOver();
}

function triggerGameOver() {
    gameState = 'GAMEOVER'; gifElement.style.display = 'none'; lastCycleIdx = -1; activePower = null;
    if (score > highScore) { highScore = score; localStorage.setItem('caughtHighScore', highScore); }
    musicTracks.forEach(t => { t.pause(); t.currentTime = 0; t.volume = 0; });
}

function draw() {
    ctx.clearRect(0, 0, 600, 600);
    
    let bgImg = assets[selectedBG];
    if (bgImg.complete) {
        ctx.save(); 
        ctx.globalAlpha = 0.75; 
        ctx.drawImage(bgImg, 0, 0, 600, 600); 
        ctx.restore();
    }

    if (gameState !== 'MAIN_MENU') {
        ctx.save();
        if (activePower === 'SHIELD') ctx.globalAlpha = 0.4;
        catPaws.forEach(p => { 
            if (assets.paw.complete) { 
                ctx.drawImage(assets.paw, p.x, p.yB, 300, 450); 
                ctx.save(); ctx.translate(p.x + 150, p.yT); ctx.scale(1,-1); ctx.drawImage(assets.paw, -150,0,300,450); ctx.restore(); 
            } 
        });
        ctx.restore();

        stars.forEach(s => {
            ctx.save(); ctx.translate(s.x, s.y); 
            // MAGNET EFFECT: Faster rotation and stronger glow
            let rotationSpeed = activePower === 'MAGNET' ? frames * 0.2 : frames * 0.05;
            ctx.rotate(rotationSpeed); 
            ctx.fillStyle = '#FFD700'; 
            ctx.shadowBlur = activePower === 'MAGNET' ? 20 : 10; 
            ctx.shadowColor = '#FFD700'; 
            drawStar(0, 0, 5, 12, 6); 
            ctx.restore();
        });

        particles.forEach(p => {
            ctx.save(); ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill(); ctx.restore();
        });

        powerUps.forEach(pu => { if (assets.fish.complete) ctx.drawImage(assets.fish, pu.x-35, pu.y-27, 70, 55); });

        ctx.save(); ctx.translate(120, catY);
        if (activePower) { ctx.strokeStyle = "white"; ctx.lineWidth = 4; ctx.beginPath(); ctx.arc(0, 0, 55, 0, Math.PI*2); ctx.stroke(); }
        ctx.rotate(rollAngle); if (selectedCatImg.complete) ctx.drawImage(selectedCatImg, -45, -45, 90, 90); ctx.restore();
        
        ctx.fillStyle = "white"; ctx.font = "bold 22px Arial"; ctx.textAlign = "left"; ctx.fillText(`Stars: ${starsCount}`, 20, 40);
    }

    if (gameState === 'MAIN_MENU') {
        ctx.fillStyle = "rgba(0,0,0,0.7)"; ctx.fillRect(0,0,600,600);
        ctx.fillStyle = "white"; ctx.textAlign="center"; ctx.font = "bold 50px Arial"; ctx.fillText("CAUGHT!", 300, 80);
        ctx.font = "bold 14px Arial"; ctx.fillText("SELECT YOUR CAT", 300, 130);
        charCards.forEach(c => {
            let h = (mouseX > c.x-40 && mouseX < c.x+40 && mouseY > c.y-40 && mouseY < c.y+40);
            ctx.save(); ctx.translate(c.x, c.y);
            if (h || selectedCatImg === c.img) { ctx.strokeStyle = "#FFD700"; ctx.lineWidth = 3; ctx.strokeRect(-42, -42, 84, 84); }
            ctx.rotate(c.hoverAngle); if (c.img.complete) ctx.drawImage(c.img, -35, -35, 70, 70); ctx.restore();
        });
        ctx.fillText("CHOOSE WORLD", 300, 315);
        bgOptions.forEach(opt => {
            let h = (mouseX > opt.x-45 && mouseX < opt.x+45 && mouseY > opt.y-20 && mouseY < opt.y+20);
            ctx.fillStyle = (selectedBG === opt.id) ? "#FFD700" : (h ? "white" : "rgba(255,255,255,0.4)");
            ctx.font = (selectedBG === opt.id) ? "bold 15px Arial" : "13px Arial";
            ctx.fillText(opt.label, opt.x, opt.y);
        });
        ctx.fillStyle = "white"; ctx.font = "bold 30px Arial"; ctx.fillText("START GAME", 300, 510);
    } 
    
    if (gameState === 'GAMEOVER') {
        ctx.fillStyle = "rgba(0,0,0,0.85)"; ctx.fillRect(0,0,600,600);
        ctx.fillStyle = "white"; ctx.textAlign = "center";
        ctx.font = "bold 65px Arial"; ctx.fillText("CAUGHT!", 300, 210);
        ctx.font = "26px Arial"; ctx.fillText(`Score: ${score}`, 300, 280);
        ctx.fillText(`Stars: ${starsCount}`, 300, 320);
        ctx.fillStyle = "#FFD700"; ctx.fillText(`Best: ${highScore}`, 300, 380);
        ctx.fillStyle = "white"; ctx.font = "bold 22px Arial"; ctx.fillText("CLICK FOR MENU", 300, 500);
    }

    if (gameState === 'PLAY' && splashTimer > 0) {
        ctx.save(); ctx.textAlign="center"; ctx.font="bold 60px Arial"; ctx.fillStyle="white"; ctx.shadowBlur=15; ctx.shadowColor="white"; ctx.fillText(splashText, 300, 300); ctx.restore();
    }
}

canvas.addEventListener('mousemove', (e) => { const r = canvas.getBoundingClientRect(); mouseX = e.clientX - r.left; mouseY = e.clientY - r.top; });
canvas.addEventListener('mousedown', () => {
    if (gameState === 'MAIN_MENU') {
        charCards.forEach(c => { if (mouseX > c.x-40 && mouseX < c.x+40 && mouseY > c.y-40 && mouseY < c.y+40) selectedCatImg = c.img; });
        bgOptions.forEach(opt => { if (mouseX > opt.x-45 && mouseX < opt.x+45 && mouseY > opt.y-20 && mouseY < opt.y+20) selectedBG = opt.id; });
        if (mouseX > 200 && mouseX < 400 && mouseY > 470 && mouseY < 540) { 
            gameState = 'PLAY'; score=0; starsCount=0; catPaws=[]; stars=[]; powerUps=[]; lastCycleIdx = -1; particles=[]; catY=300; catV=0;
        }
    } else if (gameState === 'PLAY') { catV = -7.4; } else if (gameState === 'GAMEOVER') { gameState = 'MAIN_MENU'; }
});
function loop() { update(); draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>