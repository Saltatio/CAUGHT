<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Caught! - Mobile Fixed</title>
    <style>
        :root { -webkit-tap-highlight-color: rgba(0,0,0,0); }
        body { 
            margin: 0; background: #111; display: flex; justify-content: center; align-items: center; 
            height: 100vh; font-family: 'Segoe UI', sans-serif; overflow: hidden; touch-action: none; 
        }
        #game-container { position: relative; width: 100vw; height: 100vh; background: #000; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; z-index: 1; }
        #seasonal-gif { 
            position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; 
            opacity: 0.15; z-index: 5; pointer-events: none; mix-blend-mode: screen; display: none; 
        }
        /* The Overlay now lets clicks pass through to the canvas for selection */
        #start-overlay { 
            position: absolute; inset: 0; z-index: 20; display: flex; flex-direction: column;
            align-items: center; justify-content: flex-end; padding-bottom: 50px;
            background: rgba(0,0,0,0.3); pointer-events: none; 
        }
        #start-button { 
            pointer-events: auto; padding: 20px 60px; font-size: 24px; border-radius: 50px; 
            border: none; background: #DAA520; color: #fff; font-weight: bold; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.5); cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <img id="seasonal-gif" src="" alt="seasonal-effect">
        <div id="start-overlay">
            <h1 style="color:white; font-size: 40px; margin-bottom: auto; padding-top: 40px; text-shadow: 2px 2px 10px black;">CAUGHT!</h1>
            <button id="start-button">START GAME</button>
        </div>
    </div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const gifElement = document.getElementById('seasonal-gif');
const startOverlay = document.getElementById('start-overlay');
const startButton = document.getElementById('start-button');

let W, H, bgX = 0;
function resize() {
    W = window.innerWidth; H = window.innerHeight;
    canvas.width = W; canvas.height = H;
}
window.addEventListener('resize', resize);
resize();

// --- ASSETS ---
const assets = {
    day: new Image(), afternoon: new Image(), evening: new Image(),
    paw: new Image(), fish: new Image(),
    cat_default: new Image(), cat_black: new Image(), cat_tabby: new Image()
};
assets.day.src = 'day.png'; assets.afternoon.src = 'afternoon.png'; assets.evening.src = 'evening.png';
assets.paw.src = 'paw.png'; assets.fish.src = 'fish.png';
assets.cat_default.src = 'cat.png'; assets.cat_black.src = 'cat_black.png'; assets.cat_tabby.src = 'cat_tabby.png';

const musicFiles = ['spring.mp3','summer.mp3','autumn.mp3'];
const musicTracks = musicFiles.map(f => { let a = new Audio(f); a.loop = true; a.volume = 0; return a; });
const timeGifs = ['spring.gif', 'summer.gif', 'autumn.gif'];

// --- STATE ---
let gameState = 'MAIN_MENU', score = 0, starsCount = 0, frames = 0, lastCycleIdx = -1;
let catX = 80, catY = H/2, catV = 0, catPaws = [], stars = [], powerUps = [], particles = [], rollAngle = 0;
let selectedCatImg = assets.cat_default, activePower = null, powerTimer = 0, splashText = "", splashTimer = 0;
let selectedBG = 'day', lastTime = performance.now();

const charOptions = [
    { img: assets.cat_default, x: 0 },
    { img: assets.cat_black, x: 0 },
    { img: assets.cat_tabby, x: 0 }
];

const worldOptions = [
    { id: 'day', label: 'MORNING' },
    { id: 'afternoon', label: 'NOON' },
    { id: 'evening', label: 'NIGHT' }
];

// --- UTILS ---
function createBurst(x, y) {
    for(let i=0; i<12; i++) {
        particles.push({
            x, y, vx: (Math.random()-0.5)*15, vy: (Math.random()-0.5)*15,
            life: 1.0, size: Math.random()*3+2, color: '#FFD700'
        });
    }
}

function updateMasterSync() {
    let idx = Math.floor(starsCount / 20) % 3;
    if (idx !== lastCycleIdx && gameState === 'PLAY') {
        gifElement.src = timeGifs[idx]; gifElement.style.display = 'block'; lastCycleIdx = idx;
    }
    musicTracks.forEach((t, i) => {
        if (gameState === 'PLAY' && i === idx) {
            if (t.paused) t.play().catch(()=>{});
            t.volume = Math.min(t.volume + 0.02, 0.4);
        } else {
            t.volume = Math.max(t.volume - 0.05, 0);
            if (t.volume === 0 && !t.paused) { t.pause(); t.currentTime = 0; }
        }
    });
}

function update(dt) {
    if (gameState === 'MAIN_MENU') return;
    if (gameState !== 'PLAY') return;

    frames++;
    updateMasterSync();

    let speed = (W * 0.012 + (score * 0.1)) * (activePower === 'SLOW' ? 0.5 : 1);
    bgX = (bgX - (speed * 0.15)) % W;
    rollAngle += 0.15;

    if (powerTimer > 0) powerTimer--; else activePower = null;
    if (splashTimer > 0) splashTimer--;

    if (frames % 100 === 0) {
        let gap = H * 0.32, h = Math.random() * (H - gap - 300) + 150, pX = W + 100;
        catPaws.push({ x: pX, yT: h, yB: h + gap, passed: false });
        stars.push({ x: pX + 75, y: h + gap/2, collected: false });
        if (starsCount > 0 && starsCount % 10 === 0 && powerUps.length === 0) {
            powerUps.push({ x: W + 500, y: Math.random()*(H-300)+150, type: ['SHIELD','MAGNET','SLOW'][Math.floor(Math.random()*3)] });
        }
    }

    catPaws.forEach(p => {
        p.x -= speed;
        if (catX + 30 > p.x && catX - 30 < p.x + 150) {
            if ((catY - 40 < p.yT || catY + 40 > p.yB) && activePower !== 'SHIELD') triggerGameOver();
        }
        if (!p.passed && p.x + 150 < catX) { score++; p.passed = true; }
    });

    stars.forEach(s => {
        s.x -= speed;
        let d = Math.sqrt((catX-s.x)**2 + (catY-s.y)**2);
        if (activePower === 'MAGNET' && d < 250) { s.x += (catX-s.x)*0.15; s.y += (catY-s.y)*0.15; }
        if (!s.collected && d < 60) { s.collected = true; createBurst(s.x, s.y); starsCount++; }
    });

    powerUps.forEach(pu => {
        pu.x -= speed;
        if (Math.sqrt((catX-pu.x)**2 + (catY-pu.y)**2) < 70) {
            activePower = pu.type; powerTimer = 480; splashText = pu.type; splashTimer = 90; pu.x = -2000;
        }
    });

    particles.forEach(p => { p.x += p.vx; p.y += p.vy; p.life -= 0.025; });
    particles = particles.filter(p => p.life > 0);
    
    catV += 0.65; catY += catV;
    if (catY > H + 50 || catY < -50) triggerGameOver();
}

function triggerGameOver() {
    gameState = 'GAMEOVER';
    musicTracks.forEach(t => { t.pause(); t.currentTime = 0; t.volume = 0; });
}

// --- DRAWING ---
function draw() {
    ctx.clearRect(0, 0, W, H);
    
    if (assets[selectedBG].complete) {
        ctx.globalAlpha = 0.5;
        ctx.drawImage(assets[selectedBG], bgX, 0, W, H);
        ctx.drawImage(assets[selectedBG], bgX + W, 0, W, H);
        ctx.globalAlpha = 1;
    }

    if (gameState === 'MAIN_MENU') {
        ctx.fillStyle = "rgba(255,255,255,0.8)"; ctx.fillRect(0,0,W,H);
        ctx.fillStyle = "#222"; ctx.textAlign="center"; ctx.font="bold 24px Arial";
        ctx.fillText("TAP TO CHOOSE CAT", W/2, H*0.25);
        
        charOptions.forEach((opt, i) => {
            let x = W/2 + (i-1)*100; opt.x = x;
            ctx.save(); ctx.translate(x, H*0.38);
            if (selectedCatImg === opt.img) {
                ctx.strokeStyle = "#DAA520"; ctx.lineWidth = 5; ctx.strokeRect(-45, -45, 90, 90);
            }
            ctx.drawImage(opt.img, -40, -40, 80, 80); ctx.restore();
        });

        ctx.fillText("TAP TO CHOOSE WORLD", W/2, H*0.58);
        worldOptions.forEach((opt, i) => {
            let y = H*0.68 + i*55; opt.y = y;
            ctx.fillStyle = selectedBG === opt.id ? "#DAA520" : "#999";
            ctx.font = selectedBG === opt.id ? "bold 28px Arial" : "22px Arial";
            ctx.fillText(opt.label, W/2, y);
        });
    }

    if (gameState === 'PLAY' || gameState === 'GAMEOVER') {
        ctx.save(); if (activePower === 'SHIELD') ctx.globalAlpha = 0.3;
        catPaws.forEach(p => {
            ctx.drawImage(assets.paw, p.x, p.yB, 150, H);
            ctx.save(); ctx.translate(p.x + 75, p.yT); ctx.scale(1,-1); ctx.drawImage(assets.paw, -75, 0, 150, H); ctx.restore();
        }); ctx.restore();

        stars.forEach(s => {
            ctx.save(); ctx.shadowBlur = 15; ctx.shadowColor = "#FFD700"; ctx.fillStyle = "#FFD700";
            ctx.translate(s.x, s.y); ctx.rotate(frames * 0.05);
            ctx.beginPath(); for(let i=0;i<10;i++){let r=i%2?20:10;let a=Math.PI*i/5;ctx.lineTo(r*Math.sin(a),-r*Math.cos(a));}
            ctx.closePath(); ctx.fill(); ctx.restore();
        });

        particles.forEach(p => { ctx.save(); ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill(); ctx.restore(); });
        powerUps.forEach(pu => ctx.drawImage(assets.fish, pu.x-40, pu.y-30, 80, 60));

        ctx.save(); ctx.translate(catX, catY);
        if (activePower) { ctx.beginPath(); ctx.arc(0,0,55,0,Math.PI*2); ctx.strokeStyle = "#fff"; ctx.lineWidth = 5; ctx.stroke(); }
        ctx.rotate(rollAngle); ctx.drawImage(selectedCatImg, -45, -45, 90, 90); ctx.restore();

        ctx.fillStyle = "#333"; ctx.font = "bold 24px Arial"; ctx.textAlign="left";
        ctx.fillText(`Stars: ${starsCount}`, 25, 55);
    }

    if (gameState === 'GAMEOVER') {
        ctx.fillStyle = "rgba(0,0,0,0.85)"; ctx.fillRect(0,0,W,H);
        ctx.fillStyle = "#fff"; ctx.textAlign="center"; ctx.font="bold 40px Arial"; ctx.fillText("CAUGHT!", W/2, H/2 - 20);
        ctx.font="20px Arial"; ctx.fillText("TAP TO RE-SELECT", W/2, H/2 + 40);
    }

    if (splashTimer > 0) {
        ctx.save(); ctx.shadowBlur = 10; ctx.shadowColor = "white"; ctx.fillStyle = "#333"; 
        ctx.font = "bold 60px Arial"; ctx.textAlign="center"; ctx.fillText(splashText, W/2, H/2); ctx.restore();
    }
}

function loop(t) {
    update((t - lastTime)/1000); draw(); lastTime = t; requestAnimationFrame(loop);
}

function handleInput(e) {
    if (e.type === 'touchstart') e.preventDefault();
    const touch = e.touches ? e.touches[0] : e;
    const rect = canvas.getBoundingClientRect();
    const x = (touch.clientX - rect.left) * (W / rect.width);
    const y = (touch.clientY - rect.top) * (H / rect.height);

    if (gameState === 'MAIN_MENU') {
        charOptions.forEach(opt => { if (Math.abs(x - opt.x) < 50 && Math.abs(y - H*0.38) < 50) selectedCatImg = opt.img; });
        worldOptions.forEach(opt => { if (Math.abs(x - W/2) < 120 && Math.abs(y - opt.y) < 30) selectedBG = opt.id; });
    } else if (gameState === 'PLAY') {
        catV = -11.5;
    } else if (gameState === 'GAMEOVER') {
        gameState = 'MAIN_MENU'; startOverlay.style.display = 'flex';
    }
}

window.addEventListener('touchstart', handleInput, {passive: false});
window.addEventListener('mousedown', handleInput);

startButton.addEventListener('click', (e) => {
    e.stopPropagation();
    musicTracks.forEach(t => { t.play().then(()=>t.pause()); });
    startOverlay.style.display = 'none';
    catY = H/2; catV = 0; catPaws = []; stars = []; powerUps = []; particles = []; score = 0; starsCount = 0; lastCycleIdx = -1;
    gameState = 'PLAY';
});

// Start the drawing loop immediately to show the menu
requestAnimationFrame(loop);
</script>
</body>
</html>